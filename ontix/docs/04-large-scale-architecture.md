# 海量數據架構設計

當社交媒體貼文數量達到千萬級別時，如何設計系統架構來高效處理。

---

## 一、規模假設

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 數據規模假設                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  日均採集量    : 500 萬 - 5000 萬 篇貼文                     │
│  峰值 QPS      : 10,000+ 篇/秒 (熱點事件爆發時)             │
│  監控品牌數    : 100 - 1000 個                              │
│  監控關鍵詞    : 10,000+                                    │
│  歷史數據      : 3 年，約 500 億條                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、核心設計原則

### 原則 1: 不是每篇文章都值得成為 Object

```
99% 的貼文 → 聚合統計 (熱度、情感分布)
 1% 的關鍵貼文 → 完整 Object (可追溯、可操作)
```

### 原則 2: 分層抽象，逐級聚合

```
原始層 → 信號層 → 對象層 → 事件層
(存儲便宜)  (實時計算)  (業務語義)  (決策閉環)
```

### 原則 3: 熱數據快處理，冷數據慢分析

```
實時流 (秒級) : 風險識別、預警觸發
近實時 (分鐘) : 趨勢計算、聚合更新
批處理 (小時) : 深度分析、模型訓練
```

---

## 三、四層架構設計

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│  Layer 4: Ontology 對象層 (業務語義)                                    │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐               │
│  │ Event     │ │ Alert     │ │ KeyPost   │ │ KeyAuthor │  ← 精細對象   │
│  │ 數千/日   │ │ 數百/日   │ │ 數萬/日   │ │ 數萬      │    可操作     │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘               │
│       ▲              ▲             ▲             ▲                      │
│       │              │             │             │                      │
│  ─────┼──────────────┼─────────────┼─────────────┼──── 晉升條件 ────── │
│       │              │             │             │                      │
│  Layer 3: 信號聚合層 (近實時)                                           │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │  Topic Signals        Brand Signals         Author Signals        │ │
│  │  ┌─────────────┐     ┌─────────────┐       ┌─────────────┐       │ │
│  │  │ 話題熱度曲線 │     │ 品牌情感指數 │       │ 影響力分數   │       │ │
│  │  │ 情感分布    │     │ 聲量趨勢    │       │ 活躍度      │       │ │
│  │  │ 關鍵詞雲    │     │ 風險分數    │       │ 立場傾向    │       │ │
│  │  └─────────────┘     └─────────────┘       └─────────────┘       │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│       ▲                       ▲                       ▲                │
│       │                       │                       │                │
│  ─────┴───────────────────────┴───────────────────────┴──── 聚合 ───── │
│                               │                                        │
│  Layer 2: 流處理層 (實時)                                              │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │   Kafka / Pulsar 消息隊列                                         │ │
│  │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │ │
│  │   │ 清洗    │→│ 去重    │→│ 情感    │→│ 實體    │→│ 風險    │   │ │
│  │   │ Filter  │ │ Dedup   │ │ Enrich  │ │ Extract │ │ Score   │   │ │
│  │   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │ │
│  │                        Flink / Spark Streaming                    │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│       ▲                                                                │
│       │                                                                │
│  Layer 1: 數據採集層                                                   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐             │
│  │ 微博 API  │ │ 小紅書    │ │ 抖音      │ │ 新聞媒體  │  ...        │
│  │ Crawler   │ │ Crawler   │ │ Crawler   │ │ RSS/API   │             │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、對象晉升機制

### 核心理念：不是所有貼文都成為 Object

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 📊 貼文分級處理策略                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   原始貼文 (100%)                                                       │
│       │                                                                 │
│       ▼                                                                 │
│   ┌─────────────────────────────────────────┐                          │
│   │           實時風險評分器                 │                          │
│   │   score = f(情感, 傳播速度, 作者影響力,  │                          │
│   │            關鍵詞命中, 圖片敏感度)       │                          │
│   └─────────────────────────────────────────┘                          │
│       │                                                                 │
│       ├─── score < 30 ──→ 📦 冷存儲 (S3/OSS)                           │
│       │                    僅保留統計聚合，原文壓縮歸檔                  │
│       │                    佔比: ~85%                                   │
│       │                                                                 │
│       ├─── 30 ≤ score < 70 ──→ 📊 信號貢獻                             │
│       │                         參與聚合計算，不建立獨立 Object         │
│       │                         保留 7 天熱數據                         │
│       │                         佔比: ~14%                              │
│       │                                                                 │
│       └─── score ≥ 70 ──→ ⭐ 晉升為 KeyPost Object                      │
│                            完整屬性、可追溯、可操作                      │
│                            佔比: ~1%                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 風險評分公式

```python
def calculate_risk_score(post):
    """
    計算貼文風險分數 (0-100)
    """
    score = 0

    # 情感因子 (0-25分)
    sentiment_score = (1 - post.sentiment) / 2 * 25  # 越負面分越高

    # 作者影響力 (0-20分)
    if post.author.followers > 100000:
        influence_score = 20
    elif post.author.followers > 10000:
        influence_score = 15
    elif post.author.followers > 1000:
        influence_score = 10
    else:
        influence_score = 5

    # 傳播速度 (0-25分)
    velocity = post.engagement_per_minute
    if velocity > 100:
        spread_score = 25
    elif velocity > 50:
        spread_score = 20
    elif velocity > 10:
        spread_score = 15
    else:
        spread_score = velocity * 0.5

    # 敏感關鍵詞 (0-15分)
    sensitive_keywords = ['投訴', '維權', '曝光', '食品安全', '蟲子', '異物']
    keyword_hits = sum(1 for kw in sensitive_keywords if kw in post.content)
    keyword_score = min(keyword_hits * 5, 15)

    # 證據因子 (0-15分)
    evidence_score = 0
    if post.images:
        evidence_score += 8
    if post.has_receipt:
        evidence_score += 7

    return sentiment_score + influence_score + spread_score + keyword_score + evidence_score
```

### 動態晉升：普通貼文可以「逆襲」

即使初始評分低，滿足以下任一條件也會晉升為 KeyPost：

| 觸發條件 | 閾值 | 說明 |
|----------|------|------|
| 傳播量突破 | 轉發 > 500 或 評論 > 200 | 自然傳播達到閾值 |
| 被 KOL 轉發 | 被粉絲 > 10w 帳號轉發 | 影響力放大 |
| 情感急劇變化 | 討論情感方差 > 0.5 | 爭議性內容 |
| 媒體跟進 | 被新聞媒體引用 | 出圈風險 |
| 人工標記 | 分析師手動標記 | 專業判斷 |

晉升後處理：
1. 從冷存儲恢復完整數據
2. 建立完整 Object 及 Relations
3. 回溯關聯歷史討論

---

## 五、信號聚合層設計

### Brand Signal（品牌信號對象）

每小時自動聚合生成，用於快速查詢和趨勢分析。

```
┌─────────────────────────────────────────────────────────────┐
│ BRAND_SIGNAL Object #BS-茶顏悅色-20240129-14                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  時間窗口     : 2024-01-29 14:00 - 15:00                    │
│  原始貼文數   : 12,847 篇                                    │
│  KeyPost 數   : 23 篇 (已晉升為獨立 Object)                  │
│                                                             │
│  聚合指標：                                                  │
│  ├─ 情感分布   : 正面 45% | 中性 38% | 負面 17%             │
│  ├─ 情感均值   : +0.23 (較上小時 -0.15 ⬇️)                  │
│  ├─ 聲量環比   : +340% 🔺 (異常)                            │
│  ├─ 傳播速度   : 2,847 次/小時                              │
│  └─ 風險分數   : 78/100 🔴                                  │
│                                                             │
│  熱門關鍵詞 (TF-IDF)：                                       │
│  └─ #蟲子 (新增🆕)  #食品安全  #避雷  #噁心  #長沙          │
│                                                             │
│  異常檢測：                                                  │
│  └─ ⚠️ 負面情感突增，偏離基線 3.2 個標準差                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Topic Signal（話題信號對象）

跨品牌的話題級聚合，用於行業洞察。

```
┌─────────────────────────────────────────────────────────────┐
│ TOPIC_SIGNAL Object #TS-食品安全-20240129                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  話題名稱     : 食品安全                                     │
│  今日貼文數   : 89,234 篇                                    │
│  涉及品牌     : 147 個                                       │
│                                                             │
│  品牌熱度排名 (今日)：                                       │
│  ├─ 1. 茶顏悅色   8,234 篇  ⬆️ +2847%   🔴 負面主導        │
│  ├─ 2. 蜜雪冰城   2,123 篇  ⬆️ +12%     🟢 正面主導        │
│  ├─ 3. 海底撈     1,847 篇  ⬇️ -5%      🟡 中性主導        │
│  └─ ...                                                     │
│                                                             │
│  話題生命週期 : 📈 爆發期                                    │
│  預測峰值     : 今日 18:00 - 20:00                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Author Signal（作者信號對象）

按需創建，用於 KOL/KOC 監控。

```
┌─────────────────────────────────────────────────────────────┐
│ AUTHOR_SIGNAL Object #AS-XHS-889234                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用戶         : @愛喝奶茶的小魚                              │
│  平台         : 小紅書                                       │
│                                                             │
│  活躍度指標：                                                │
│  ├─ 本週發帖   : 12 篇                                      │
│  ├─ 平均互動   : 856 次/篇                                  │
│  └─ 活躍時段   : 12:00-14:00, 20:00-22:00                  │
│                                                             │
│  影響力指標：                                                │
│  ├─ 粉絲增長   : +2,341 (本週)                              │
│  ├─ 內容傳播率 : 23% (高於均值)                             │
│  └─ 評論情感   : 主要正面                                   │
│                                                             │
│  品牌關聯：                                                  │
│  ├─ 茶顏悅色   : 3 篇 (2正面, 1負面)                        │
│  ├─ 喜茶       : 2 篇 (2正面)                               │
│  └─ 瑞幸       : 1 篇 (1正面)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、存儲架構設計

### 分層存儲策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 💾 分層存儲架構                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 熱數據層 (Hot) - 實時查詢                                        │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ 存儲介質 : Redis Cluster + Elasticsearch                        │   │
│  │ 數據範圍 : 最近 24 小時                                          │   │
│  │ 數據類型 : KeyPost Objects, Signals, Alerts                     │   │
│  │ 查詢延遲 : < 100ms                                               │   │
│  │ 數據量   : ~500 GB                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼ 24h 後降級                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 溫數據層 (Warm) - 分析查詢                                       │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ 存儲介質 : ClickHouse / Doris (列式存儲)                        │   │
│  │ 數據範圍 : 最近 90 天                                            │   │
│  │ 數據類型 : 聚合後的 Signals, 採樣原文                           │   │
│  │ 查詢延遲 : < 3s                                                  │   │
│  │ 數據量   : ~20 TB                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼ 90d 後歸檔                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 冷數據層 (Cold) - 合規存儲 & 深度分析                            │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ 存儲介質 : S3/OSS + Parquet 格式                                │   │
│  │ 數據範圍 : 全部歷史 (3年+)                                       │   │
│  │ 數據類型 : 壓縮原文、聚合統計                                    │   │
│  │ 查詢延遲 : 分鐘級 (需預熱)                                       │   │
│  │ 數據量   : ~500 TB                                               │   │
│  │ 成本     : 約 $0.02/GB/月                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 各層技術選型

| 層級 | 存儲組件 | 用途 | 數據保留 |
|------|----------|------|----------|
| 熱 | Redis Cluster | 實時狀態、計數器 | 24h |
| 熱 | Elasticsearch | 全文檢索、KeyPost | 7d |
| 溫 | ClickHouse | 聚合分析、Signal | 90d |
| 冷 | S3 + Parquet | 歸檔、合規、訓練 | 3y+ |

---

## 七、Ontology 對象數量控制

### 對象數量估算（日均 1000 萬貼文場景）

| 對象類型 | 日新增 | 存活週期 | 活躍對象總數 |
|----------|--------|----------|--------------|
| RawPost (原始) | 10,000,000 | 僅流過 | 0 (不持久化) |
| KeyPost (關鍵) | 100,000 | 90 天 | ~9,000,000 |
| BrandSignal | 24 x 品牌數 | 滾動 90 天 | ~200,000 |
| TopicSignal | 24 x 話題數 | 滾動 30 天 | ~50,000 |
| AuthorSignal | 按需創建 | 滾動 180 天 | ~500,000 |
| Event | ~50 | 直到結案 | ~200 活躍 |
| Alert | ~200 | 直到關閉 | ~500 活躍 |
| Response | ~100 | 永久 | 累計 ~30,000 |

**核心洞察**：通過聚合，將 1000萬/天 壓縮為 ~10萬 個有意義的 Objects

### KeyPost 自動降級規則

```yaml
keypost_lifecycle:
  active:
    duration: 7 days
    storage: hot (Redis + ES)

  warm:
    trigger: 7天無新互動
    action: 壓縮屬性，移至 ClickHouse
    keep: 核心屬性 + 摘要

  cold:
    trigger: 30天無關聯
    action: 移至冷存儲
    keep: ID + 摘要 + 統計

  archive:
    trigger: 90天後
    action: 僅保留元數據
    keep: ID + 創建時間 + 情感標籤
```

---

## 八、實時處理流水線

### Flink 處理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ⚡ Flink Job: sentiment_enrichment_pipeline                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Kafka Topic: raw_posts                                                 │
│       │                                                                 │
│       ▼                                                                 │
│  ┌────────────────┐                                                    │
│  │ 1. 清洗 & 去重  │  ← 布隆過濾器去重，過濾垃圾內容                   │
│  │    (~5ms)      │                                                    │
│  └───────┬────────┘                                                    │
│          │                                                              │
│          ▼                                                              │
│  ┌────────────────┐                                                    │
│  │ 2. 實體識別    │  ← 品牌/人物/地點 NER                              │
│  │    (~20ms)     │                                                    │
│  └───────┬────────┘                                                    │
│          │                                                              │
│          ▼                                                              │
│  ┌────────────────┐                                                    │
│  │ 3. 情感分析    │  ← 輕量級模型 (DistilBERT)                         │
│  │    (~30ms)     │                                                    │
│  └───────┬────────┘                                                    │
│          │                                                              │
│          ▼                                                              │
│  ┌────────────────┐                                                    │
│  │ 4. 風險評分    │  ← 實時特徵計算                                    │
│  │    (~5ms)      │                                                    │
│  └───────┬────────┘                                                    │
│          │                                                              │
│   ┌──────┴──────┐                                                      │
│   ▼             ▼                                                      │
│ score<70    score≥70                                                   │
│   │             │                                                      │
│   ▼             ▼                                                      │
│ 聚合窗口     KeyPost創建                                                │
│ (1min)      + Alert檢測                                                │
│   │             │                                                      │
│   ▼             ▼                                                      │
│ ClickHouse  Elasticsearch + Redis                                      │
│                 │                                                      │
│                 ▼                                                      │
│           Alert觸發 → 推送通知                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 處理性能指標

| 指標 | 目標值 | 說明 |
|------|--------|------|
| 端到端延遲 | < 200ms | 從採集到可查詢 |
| 吞吐量 | 10,000 QPS | 峰值處理能力 |
| 去重準確率 | > 99% | 布隆過濾器 |
| 情感分析延遲 | < 50ms | GPU 推理 |

---

## 九、成本估算

### 月度成本（日均 1000 萬貼文）

| 組件 | 規格 | 月成本 (USD) |
|------|------|--------------|
| 數據採集 (爬蟲集群) | 20 節點 | $2,000 |
| 消息隊列 (Kafka) | 3 節點, 高可用 | $1,500 |
| 流處理 (Flink) | 10 TaskManager | $3,000 |
| 熱存儲 (ES + Redis) | 500GB SSD | $2,500 |
| 溫存儲 (ClickHouse) | 20TB | $1,500 |
| 冷存儲 (S3) | 500TB | $10,000 |
| GPU (情感分析) | 2x A10 | $2,000 |
| **合計** | | **~$22,500/月** |

**對比**：如果不做聚合，全量存儲+查詢成本約 $150,000/月

---

## 十、查詢優化策略

### 查詢路由

```
用戶查詢 → 查詢解析 → 路由決策 → 對應存儲層
                           │
        ┌──────────────────┼──────────────────┐
        ▼                  ▼                  ▼
   實時狀態查詢        聚合分析查詢        歷史回溯查詢
   → Redis/ES          → ClickHouse         → S3 + Spark
   < 100ms             < 3s                 分鐘級
```

### 預聚合避免全量掃描

**錯誤方式**：查詢"過去7天茶顏悅色負面聲量"時掃描 7000 萬條原始貼文

**正確方式**：查詢預聚合的 BrandSignal

```sql
SELECT
  time_bucket,
  negative_count,
  negative_ratio,
  sentiment_avg
FROM brand_signals_hourly
WHERE brand_id = '茶顏悅色'
  AND time_bucket >= now() - interval '7 days'
ORDER BY time_bucket

-- 掃描行數: 168 行 (7天 x 24小時)
-- 響應時間: < 100ms
```

---

## 十一、總結

### 海量數據下的 Ontology 設計要點

| 設計原則 | 具體做法 |
|----------|----------|
| **分層抽象** | 原始數據 → 信號聚合 → 業務對象 → 事件決策 |
| **選擇性建模** | 只有 1% 的關鍵內容成為可操作的 Object |
| **動態晉升** | 普通內容可根據傳播表現「逆襲」為關鍵對象 |
| **時間分治** | 熱/溫/冷三層存儲，成本與性能平衡 |
| **預計算聚合** | 用 Signal 對象緩存常用查詢，避免全量掃描 |
| **流批一體** | 實時預警 + 批量深度分析並行 |
